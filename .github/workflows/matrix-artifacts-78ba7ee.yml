name: Matrix Build with Artifacts (78ba7ee)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    # 3+ parallel jobs across OS variants; Node fixed just to show a second dimension
    name: Build (${{ matrix.os }}, node ${{ matrix.node }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: matrix-78ba7ee
        run: echo "Matrix run on ${{ matrix.os }} with Node ${{ matrix.node }}"

      - name: Generate build artifact (non-empty)
        run: |
          node -e "const fs=require('fs'); const os=require('os'); const lines=[
            'Build artifact for matrix run:',
            `MatrixOS=${{ toJson(matrix.os) }}`,
            `MatrixNode=${{ toJson(matrix.node) }}`,
            `Runner=${process.env.RUNNER_NAME||''}`,
            `Platform=${process.platform}`,
            `Arch=${process.arch}`,
            `Timestamp=${new Date().toISOString()}`
          ]; fs.writeFileSync('output.txt', lines.join(os.EOL));"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          # Required prefix and unique per matrix variant
          name: build-78ba7ee-${{ matrix.os }}-node${{ matrix.node }}
          path: output.txt
          if-no-files-found: error

  verify:
    name: Verify artifacts (non-empty)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: ls -R artifacts

      - name: Assert each artifact is non-empty and at least 3 exist
        shell: bash
        run: |
          set -euo pipefail
          count=0
          while IFS= read -r -d '' f; do
            if [ -s "$f" ]; then
              echo "OK: $f ($(wc -c <"$f") bytes)"
              count=$((count+1))
            else
              echo "EMPTY: $f"
              exit 1
            fi
          done < <(find artifacts -type f -name 'output.txt' -print0)
          echo "Found $count non-empty artifacts"
          [ "$count" -ge 3 ]
